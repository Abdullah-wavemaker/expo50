{"version":3,"names":["isArray","clone","useEffect","useState","WIDGET_LOGGER","WATCH_LOGGER","extend","WatchExpression","constructor","fn","onChange","_defineProperty","last","execute","getExpBody","expBody","expStr","toString","substring","indexOf","lastIndexOf","e","isEqual","$old","$new","isArrayObj","length","i","value","check","start","Date","now","changed","lastExecutionTime","debug","Watcher","isActive","expressions","forEach","expression","children","child","create","parent","push","remove","splice","destroy","clear","watch","count","_class2","useWatcher","change","watcher"],"sources":["watcher.ts"],"sourcesContent":["import { isEqual as _isEqual, isArray, isObject, clone, remove, reverse, sortBy } from 'lodash';\nimport { useEffect, useMemo, useState } from 'react';\nimport { WIDGET_LOGGER } from '@wavemaker/app-rn-runtime/core/base.component';\n\nconst WATCH_LOGGER = WIDGET_LOGGER.extend(\"watch\");\n\nclass WatchExpression {\n    private last: any = null;\n    private expBody: string = null as any;\n    public lastExecutionTime = 0;\n\n    constructor(private fn: Function, private onChange: (prev: any, now: any) => any) {\n        this.last = this.execute();\n        if (isArray(this.last)) {\n            this.last = clone(this.last);\n        }\n    }\n\n    private getExpBody() {\n        if (!this.expBody) {\n            const expStr = this.fn.toString();\n            this.expBody = expStr.substring(\n                expStr.indexOf('return ') + 7,\n                expStr.lastIndexOf(';'));\n        }\n        return this.expBody;\n    }\n    \n    private execute() {\n        try {\n            return this.fn();\n        } catch(e) {\n            //do nothing\n            return null;\n        }\n    }\n\n    private isEqual($old: any, $new: any) {\n        const isArrayObj = isArray($old) || isArray($new);\n        if (isArrayObj) {\n            if (($old && !$new) \n                || (!$old && $new)\n                || $old.length !== $new.length) {\n                return false;\n            }\n            for(let i = 0; i < $old.length; i++) {\n                if ($old[i] !== $new[i]) {\n                    return false;\n                }\n            }\n            return true;\n        }\n        return $old === $new;\n    }\n\n    get value() {\n        return this.last;\n    }\n\n    public check() {\n        const start = Date.now();\n        const now = this.execute();\n        const changed = !this.isEqual(this.last, now);\n        this.lastExecutionTime = Date.now() - start;\n        if (changed) {\n            WATCH_LOGGER.debug(() => {\n                if (this.getExpBody() !== 'fragment') {\n                    return `Watcher: <${this.getExpBody()}> Changed from ${this.last} to ${now} `;\n                }\n                return '';\n            });\n            this.onChange(this.last, now);\n            this.last = now;\n            if (isArray(this.last)) {\n                this.last = clone(this.last);\n            }\n            return true;\n        }\n        return false;\n    }\n}\n\nexport class Watcher {\n    public static ROOT = new Watcher();\n    public expressions = [] as WatchExpression[];\n    public isActive = true;\n    public parent: Watcher = null as any;\n    public children = [] as Watcher[];\n    private constructor() {}\n\n    check() {\n        if (this.isActive) {\n            this.expressions.forEach(expression => expression.check());\n            this.children.forEach(child => {\n                child.check();\n            });\n        }\n    }\n    \n    create() {\n        const child = new Watcher();\n        child.parent = this;\n        this.children.push(child);\n        return child;\n    }\n\n    remove(child: Watcher) {\n        if (this.children.length > 0) {\n            const i = this.children.indexOf(child);\n            if (i >= 0) {\n                this.children.splice(i, 1);\n            }\n        }\n    }\n\n    destroy() {\n        this.clear();\n        this.parent && this.parent.remove(this);\n    }\n\n    clear() {\n        this.children = [];\n        this.expressions = [];\n    }\n\n    watch(fn: Function, onChange: (prev: any, now: any) => any) {\n        const expression = new WatchExpression(fn, onChange);\n        this.expressions.push(expression);\n        return expression;\n    }\n\n    count() {\n        if (!this.isActive) {\n            return 0;\n        }\n        let count = this.expressions.length;\n        this.children.forEach(child => {\n            count += child.count();\n        });\n        return count;\n    }\n}\n\nexport function useWatcher(parent: Watcher) {\n    const [change, onChange] = useState({});\n    let [ watcher ] = useState(() => parent.create());\n    watcher.clear();\n    useEffect(() => { \n        return () => {\n            watcher.destroy();\n        };\n    }, []);\n    return {\n        watch: (fn: Function) => {\n            return watcher.watch(fn, () => onChange({})).value;\n        }\n    };\n};"],"mappings":"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"}