{"version":3,"names":["React","BackHandler","Platform","View","WebView","HideMode","BaseComponent","BaseComponentState","WmWebviewProps","DEFAULT_CLASS","AccessibilityWidgetType","getAccessibilityProps","WmWebViewState","constructor","arguments","_defineProperty","title","src","WmWebview","props","webview","webViewState","canGoBack","goBack","event","_event$nativeEvent","data","nativeEvent","startsWith","id","match","callback","invokeJSCallbacks","result","substring","indexOf","parseResult","invokeEventCallback","hideMode","DONOT_ADD_TO_DOM","addEventListener","handleBackButtonPress","componentWillUnmount","removeEventListener","_this$state$currentTa","state","currentTarget","currentsrc","_this$state$currentTa2","executeScript","fn","Promise","resolve","reject","Date","now","injectJavaScript","insertCSS","style","length","undefined","replace","JSON","parse","e","getTitle","iframe","contentWindow","document","onLoad","updateState","renderWidget","createElement","styles","root","_background","OS","width","height","_extends","ref","nestedScrollEnabled","source","uri","testID","getTestId","WEBVIEW","incognito","onMessage","sharedCookiesEnabled","onNavigationStateChange","scrollEnabled","onLoadEnd","url"],"sources":["webview.component.tsx"],"sourcesContent":["import React from 'react';\nimport { BackHandler, Platform, View } from 'react-native';\nimport { WebView, WebViewNavigation, WebViewMessageEvent } from 'react-native-webview';\nimport { HideMode } from '@wavemaker/app-rn-runtime/core/if.component';\nimport { BaseComponent, BaseComponentState } from '@wavemaker/app-rn-runtime/core/base.component';\n\nimport WmWebviewProps from './webview.props';\nimport { DEFAULT_CLASS, WebviewStyles } from './webview.styles';\nimport { AccessibilityWidgetType, getAccessibilityProps } from '@wavemaker/app-rn-runtime/core/accessibility';\n\nclass WmWebViewState extends BaseComponentState<WmWebviewProps> {\n  currentTarget = {\n    title: '',\n    src: ''\n  };\n\n}\n\nexport default class WmWebview extends BaseComponent<WmWebviewProps, WmWebViewState, WebviewStyles> {\n\n  private webview: WebView | null = null as any;\n  private webViewState: WebViewNavigation = null as any;\n  private invokeJSCallbacks = {} as any;\n\n  constructor(props: WmWebviewProps) {\n    super(props, DEFAULT_CLASS, new WmWebviewProps());\n    this.hideMode = HideMode.DONOT_ADD_TO_DOM;\n    BackHandler.addEventListener('hardwareBackPress', this.handleBackButtonPress);\n  }\n\n  componentWillUnmount() {\n    super.componentWillUnmount();\n    BackHandler.removeEventListener('hardwareBackPress', this.handleBackButtonPress);\n  }\n\n  handleBackButtonPress = (): boolean => {\n    if (this.webview && this.webViewState && this.webViewState.canGoBack) {\n      this.webview.goBack();\n      return true;\n    }\n    return false;\n  }\n\n  get title() {\n    return this.state.currentTarget?.title;\n  }\n\n  get currentsrc() {\n    return this.state.currentTarget?.src;\n  }\n\n  executeScript(fn: string) {\n    return new Promise((resolve, reject) => {\n      if (this.webview) {\n        const id = '' + Date.now();\n        this.invokeJSCallbacks[id] = resolve;\n        fn = `\n         (function(){\n          try{\n            return (${fn});\n          } catch(e) {\n            return e.getMessage();\n          }\n         }())\n        `;\n        this.webview.injectJavaScript(\n          `window.ReactNativeWebView.postMessage('afterInjectJavaScript:' + ${id} + ':' + JSON.stringify(${fn}))`\n        );\n      } else {\n        reject();\n      }\n    });\n  }\n\n  insertCSS(style = '') {\n    style = style.replace(/[\\n\\t\\r]/g, '');\n    return this.executeScript(`\n    function() {\n      const style = document.createElement('style');\n      style.innerHTML = '${style}';\n      document.head.appendChild(style);\n      return 'SUCCESS';\n    }()\n    `);\n  }\n\n  parseResult(result: string) {\n    try {\n      return JSON.parse(result);\n    } catch(e) {\n      if (result === 'undefined' || result === 'null') {\n        return null;\n      }\n      return result;\n    }\n  }\n\n  onMessage = (event: WebViewMessageEvent) => {\n    const data: string = event.nativeEvent?.data;\n    if (data && data.startsWith('afterInjectJavaScript')) {\n      const id = data?.match(/\\:([0-9]+)\\:/);\n      const callback = id && this.invokeJSCallbacks[id[1]];\n      const result = data.substring(data.indexOf(':', data.indexOf(':') + 1) + 1);\n      callback && callback(this.parseResult(result));\n    } else {\n      this.invokeEventCallback('onMessage', [event, this]);\n    }\n  }\n\n  getTitle(iframe: any) {\n    try {\n      return iframe.currentTarget.contentWindow.document.title;\n    } catch(e) {\n      // browser blocks cross origin access to iframe content.\n    }\n  }\n\n  public onLoad(e: any, title: string, src: string) {\n    this.updateState({\n      currentTarget: {\n        title: title,\n        src: src\n      }\n    } as WmWebViewState, () => {\n      this.invokeEventCallback('onLoad', [e, this]);\n    });\n  }\n\n  protected renderWidget(props: WmWebviewProps) {\n    return (\n      <View style={this.styles.root}>\n        {this._background}\n        {Platform.OS === 'web' ?\n          (<iframe src={props.src} width={'100%'} height={'100%'}\n            onLoad={(e) => this.onLoad(e, this.getTitle(e.currentTarget), (e.currentTarget as any).src)}></iframe>) :\n          (<WebView\n            ref={(ref) => this.webview = ref}\n            nestedScrollEnabled={true}\n            style={this.styles.webview}\n            source={{\n              uri: props.src\n            }}\n            testID={this.getTestId('web_view')}\n            {...getAccessibilityProps(AccessibilityWidgetType.WEBVIEW, props)}\n            incognito={props.incognito}\n            onMessage={this.onMessage}\n            sharedCookiesEnabled={true}\n            onNavigationStateChange={(state) => {\n              this.webViewState = state;\n            }}\n            scrollEnabled={true}\n            onLoadEnd={(e) => this.onLoad(e, e.nativeEvent.title, e.nativeEvent.url)}>\n          </WebView>)}\n      </View>\n    );\n  }\n}\n"],"mappings":"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"}