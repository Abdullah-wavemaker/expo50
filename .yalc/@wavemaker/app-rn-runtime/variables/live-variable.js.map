{"version":3,"names":["isEqual","isUndefined","isFunction","forEach","isEmpty","LiveVariable","_LiveVariable","httpService","injector","deepCopy","Formatters","_LiveVariableEvents","constructor","config","variableConfig","name","dataSet","paramProvider","inputFields","filterExpressions","filterFields","isList","maxResults","_context","operation","type","autoUpdate","liveSource","orderBy","category","properties","propertiesMap","tableName","tableType","relatedTables","httpClientService","inFlightBehavior","onSuccess","context","args","variable","data","options","onCanUpdate","onBeforeUpdate","dataFilter","inputData","onResult","onBeforeDatasetReady","onError","_defineProperty","get","dateFormatter","init","setFilterExpValue","filter","_this$filterExpressio","rules","r","value","target","invokeOnParamChange","last","params","latest","lastFilter","filters","latestFilter","filterProvider","update","invoke","val","key","Promise","resolve","listRecords"],"sources":["live-variable.ts"],"sourcesContent":["import { VariableConfig, VariableEvents } from './base-variable';\nimport { isEqual, isUndefined, isFunction, forEach, isEmpty } from 'lodash';\nimport AppConfig from '@wavemaker/app-rn-runtime/core/AppConfig';\nimport { LiveVariable as _LiveVariable } from '@wavemaker/variables/src/model/variable/live-variable';\nimport httpService from '@wavemaker/app-rn-runtime/variables/http.service';\nimport injector from '@wavemaker/app-rn-runtime/core/injector';\nimport { deepCopy } from '@wavemaker/app-rn-runtime/core/utils';\nimport Formatters from '@wavemaker/app-rn-runtime/core/formatters';\n\nexport interface LiveVariableConfig extends VariableConfig {\n  baseUrl: string;\n  maxResults: number;\n  _context: any;\n  onCanUpdate: any;\n  onBeforeUpdate: any;\n  onResult: any;\n  onBeforeDatasetReady: any;\n  inFlightBehavior: string;\n  type: string;\n  autoUpdate: boolean;\n  orderBy: string;\n  category: string;\n  liveSource: string;\n  propertiesMap: any;\n  properties: any;\n  tableName: string;\n  tableType: string;\n  relatedTables: any;\n  filterExpressions: any;\n  filterProvider: any;\n}\n\nenum _LiveVariableEvents {\n  BEFORE_INVOKE = 'beforeInvoke'\n}\nexport type LiveVariableEvents = _LiveVariableEvents | VariableEvents;\n\nexport class LiveVariable extends _LiveVariable {\n  params: any = {};\n  filters: any = {};\n  public appConfig = injector.get<AppConfig>('APP_CONFIG');\n\n  constructor(public config: LiveVariableConfig) {\n    const variableConfig: any = {\n      name: config.name,\n      dataSet: config.paramProvider(),\n      inputFields: config.paramProvider(),\n      filterExpressions: config.filterExpressions,\n      filterFields: config.paramProvider(),\n      isList: config.isList,\n      maxResults: config.maxResults,\n      _context: config._context,\n      operation: config.operation,\n      type: config.type,\n      autoUpdate: config.autoUpdate,\n      liveSource: config.liveSource,\n      orderBy: config.orderBy,\n      category: config.category,\n      properties: config.properties,\n      propertiesMap: config.propertiesMap,\n      tableName: config.tableName,\n      tableType: config.tableType,\n      relatedTables: config.relatedTables,\n      httpClientService: httpService,\n      inFlightBehavior: config.inFlightBehavior,\n      onSuccess: (context: any, args: any) => {\n        return config.onSuccess && config.onSuccess(args.variable, args.data, args.options);\n      },\n      onCanUpdate: (context: any, args: any) => {\n        return config.onCanUpdate && config.onCanUpdate(args.variable, args.data, args.options);\n      },\n      onBeforeUpdate: (context: any, args: any) => {\n        return config.onBeforeUpdate && config.onBeforeUpdate(args.variable, args.dataFilter || args.inputData, args.options);\n      },\n      onResult: (context: any, args: any) => {\n        return config.onResult && config.onResult(args.variable, args.data, args.options);\n      },\n      onBeforeDatasetReady: (context: any, args: any) => {\n        return config.onBeforeDatasetReady && config.onBeforeDatasetReady(args.variable, args.data, args.options);\n      }\n    }\n    if (config.onError) {\n      variableConfig.onError = (context: any, args: any) => {\n        return config.onError && config.onError(args.variable, args.data, args.options);\n      };\n    }\n    super(variableConfig);\n    this.dateFormatter = Formatters.get('toDate');\n    this.init();\n  }\n\n  setFilterExpValue(filter: any) {\n    this.filterExpressions?.rules.forEach((r: any) => {\n      r.value = filter[r.target];\n    });\n  }\n\n  invokeOnParamChange() {\n    const last = this.params;\n    const latest = this.config.paramProvider();\n    if (this.config.operation === 'read') {\n      const lastFilter = this.filters;\n      const latestFilter = this.config.filterProvider && this.config.filterProvider();\n      if (!isEqual(lastFilter, latestFilter)) {\n        this.setFilterExpValue(latestFilter);\n        if (this.autoUpdate && !isEmpty(latestFilter) && isFunction(this.update)) {\n          this.filters = latestFilter;\n          this.invoke();\n        }\n      }\n    }\n    if (!isEqual(last, latest)) {\n      if (this.config.operation === 'read') {\n        forEach(latest, (val: any, key: any) => {\n          this.filterFields[key] = {\n            'value': val\n          };\n        });\n      } else {\n        this.inputFields = latest;\n      }\n      /* if auto-update set for the variable with read operation only, get its data */\n      // @ts-ignore\n      if (this.autoUpdate && !isUndefined(latest) && isFunction(this[this.config.operation + 'Record'])) {\n        this.invoke();\n      }\n    }\n    return Promise.resolve(this);\n  }\n\n  listRecords(options? : any, onSuccess?: Function, onError?: Function) {\n    this.filters = this.config.filterProvider && this.config.filterProvider();\n    if (options) {\n      this.filters = deepCopy({} as any, this.filters, options.filterFields ? options.filterFields : options);\n    }\n    options = options || {};\n    options.filterFields = this.filters;\n    this.setFilterExpValue(this.filters);\n    return super.listRecords(options, onSuccess, onError);\n  }\n\n}\n"],"mappings":"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"}