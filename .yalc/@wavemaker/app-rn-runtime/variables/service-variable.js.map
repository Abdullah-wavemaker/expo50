{"version":3,"names":["VariableEvents","isEqual","isString","deepCopy","ServiceVariable","_ServiceVariable","httpService","injector","_ServiceVariableEvents","constructor","config","variableConfig","name","dataSet","paramProvider","dataBinding","isList","service","serviceType","maxResults","_context","operation","operationId","serviceInfo","getServiceInfo","httpClientService","inFlightBehavior","onSuccess","context","args","notify","AFTER_INVOKE","variable","data","options","SUCCESS","onError","ERROR","onCanUpdate","onBeforeUpdate","BEFORE_INVOKE","inputData","onResult","onBeforeDatasetReady","_defineProperty","get","subscribe","init","invokeOnParamChange","last","params","latest","invoke","Promise","resolve","doNext","page","pagination","parseInt","reject","dataset","onDataUpdated","appConfig","refresh","inputFields","console","error"],"sources":["service-variable.ts"],"sourcesContent":["import { VariableConfig, VariableEvents } from './base-variable';\nimport { isEqual, assignIn, isString } from 'lodash';\nimport AppConfig from '@wavemaker/app-rn-runtime/core/AppConfig';\nimport { deepCopy } from '@wavemaker/app-rn-runtime/core/utils';\nimport { ServiceVariable as _ServiceVariable } from '@wavemaker/variables/src/model/variable/service-variable';\nimport httpService from '@wavemaker/app-rn-runtime/variables/http.service';\nimport injector from '@wavemaker/app-rn-runtime/core/injector';\n\nexport interface ServiceVariableConfig extends VariableConfig {\n  baseUrl: string;\n  maxResults: number;\n  _context: any;\n  serviceType: string;\n  onCanUpdate: any;\n  onBeforeUpdate: any;\n  onResult: any;\n  onBeforeDatasetReady: any;\n  inFlightBehavior: string;\n  getServiceInfo: Function;\n}\n\nenum _ServiceVariableEvents {\n  BEFORE_INVOKE = 'beforeInvoke'\n}\nexport type ServiceVariableEvents = _ServiceVariableEvents | VariableEvents;\n\nexport class ServiceVariable extends _ServiceVariable {\n  private cancelTokenSource: any;\n  params: any = {};\n  public appConfig = injector.get<AppConfig>('APP_CONFIG');\n\n  constructor(public config: ServiceVariableConfig) {\n    let variableConfig: any = {\n      name: config.name,\n      dataSet: config.paramProvider(),\n      dataBinding: {},\n      isList: config.isList,\n      service: config.service,\n      serviceType: config.serviceType,\n      maxResults: config.maxResults,\n      _context: config._context,\n      operation: config.operation,\n      operationId: config.operationId,\n      serviceInfo: config.getServiceInfo(),\n      httpClientService: httpService,\n      inFlightBehavior: config.inFlightBehavior,\n      onSuccess: (context: any, args: any) => {\n        this.notify(VariableEvents.AFTER_INVOKE, [args.variable, args.data, args.options]);\n        this.notify(VariableEvents.SUCCESS, [args.variable, args.data, args.options]);\n        return config.onSuccess && config.onSuccess(args.variable, args.data, args.options);\n      },\n      onError: (context: any, args: any) => {\n        this.notify(VariableEvents.AFTER_INVOKE, [args.variable, args.data, args.options]);\n        this.notify(VariableEvents.ERROR, [args.variable, args.data, args.options]);\n        return config.onError && config.onError(args.variable, args.data, args.options);\n      },\n      onCanUpdate: (context: any, args: any) => {\n        return config.onCanUpdate && config.onCanUpdate(args.variable, args.data, args.options);\n      },\n      onBeforeUpdate: (context: any, args: any) => {\n        this.notify(VariableEvents.BEFORE_INVOKE, [args.variable, args.inputData, args.options]);\n        return config.onBeforeUpdate && config.onBeforeUpdate(args.variable, args.inputData, args.options);\n      },\n      onResult: (context: any, args: any) => {\n        return config.onResult && config.onResult(args.variable, args.data, args.options);\n      },\n      onBeforeDatasetReady: (context: any, args: any) => {\n        return config.onBeforeDatasetReady && config.onBeforeDatasetReady(args.variable, args.data, args.options);\n      }\n    }\n    if (config.onError) {\n      variableConfig.onError = (context: any, args: any) => {\n        return config.onError && config.onError(args.variable, args.data, args.options);\n      };\n    }\n    super(variableConfig);\n    this.subscribe(VariableEvents.AFTER_INVOKE, () => {\n        this.dataBinding = {};\n    });\n    this.init();\n  }\n\n  invokeOnParamChange() {\n    const last = this.params;\n    const latest = this.config.paramProvider();\n    if (!isEqual(last, latest)) {\n      this.invoke(latest);\n    }\n    return Promise.resolve(this);\n  }\n\n  public async doNext() {\n    let page = 0 as any;\n    if (isString(this.pagination.page)) {\n      page = (parseInt(this.pagination.page) + 1) + '';\n    } else {\n      page = this.pagination.page + 1;\n    }\n    return new Promise((resolve, reject) => {\n      this.invoke({\n        page: page\n      }, \n      (dataset: any) => resolve(dataset), \n      reject);\n    });\n  }\n\n  onDataUpdated() {\n    this.appConfig.refresh(false);\n  }\n\n  invoke(options? : any, onSuccess?: Function, onError?: Function) {\n    this.params = this.config.paramProvider();\n    this.params = deepCopy({} as any, this.params, this.dataBinding);\n    if (options) {\n      this.params = deepCopy({} as any, this.params, options.inputFields ? options.inputFields : options);\n    }\n    options = options || {};\n    options.inputFields = this.params;\n      // service definitions data depends on whether user logged in or not\n    // Try to get the latest definition\n    this.serviceInfo = this.config.getServiceInfo();\n    if (!this.serviceInfo) {\n      console.error(`Service Info is missing for (${this.name}) variable.`)\n    }\n    return super.invoke(options, onSuccess, onError);\n  }\n\n  // cancel($file?: any) {\n  //   // CHecks if there is any pending requests in the queue\n  //   if ($queue.requestsQueue.has(this)) {\n  //     // If the request is a File upload request then modify the elements associated with file upload\n  //     // else unsubscribe from the observable on the variable.\n  //     if (false) {\n  //       // $file._uploadProgress.unsubscribe();\n  //       // $file.status = 'abort';\n  //       // this.totalFilesCount--;\n  //       // initiateCallback(VARIABLE_CONSTANTS.EVENT.ABORT, variable, $file);\n  //       // if (!this.isFileUploadInProgress(variable.dataBinding) && this.totalFilesCount === 0) {\n  //       //   $queue.process(variable);\n  //       //   // notify inflight variable\n  //       //   this.notifyInflight(variable, false);\n  //       // }\n  //     } else {\n  //       if (true) {\n  //         this.cancelTokenSource.cancel();\n  //         $queue.process(this);\n  //         // notify inflight variable\n  //         //this.notifyInflight(variable, false);\n  //       }\n  //     }\n  //   }\n  // }\n\n  // setInput(key: any, val?: any, options?: any) {\n  //   this.params = merge({}, this.config.paramProvider(), _setInput(this.params, key, val, options));\n  //    return this.params;\n  // }\n}\n"],"mappings":"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"}